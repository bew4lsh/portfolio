---
interface Props {
  id: string;
  data: any[];
  layout?: any;
  config?: any;
  height?: string;
  width?: string;
  className?: string;
}

const { 
  id, 
  data, 
  layout = {}, 
  config = { responsive: true, displayModeBar: 'hover' },
  height = '400px',
  width = '100%',
  className = ''
} = Astro.props;

// Default layout settings that work well with the portfolio theme
const defaultLayout = {
  paper_bgcolor: 'transparent',
  plot_bgcolor: 'transparent',
  font: {
    family: 'Public Sans, system-ui, sans-serif',
    color: 'var(--gray-200)'
  },
  margin: {
    l: 60,
    r: 40,
    t: 60,
    b: 60
  },
  ...layout
};
---

<div 
  id={id}
  class={`plotly-chart ${className}`}
  style={`height: ${height}; width: ${width}; min-height: ${height};`}
  data-plotly-data={JSON.stringify(data)}
  data-plotly-layout={JSON.stringify(defaultLayout)}
  data-plotly-config={JSON.stringify(config)}
>
  <!-- Loading skeleton -->
  <div class="chart-loading">
    <div class="loading-skeleton">
      <div class="skeleton-title"></div>
      <div class="skeleton-chart"></div>
    </div>
  </div>
</div>

<script>
  // Get current theme colors from CSS variables
  function getThemeColors() {
    const style = getComputedStyle(document.documentElement);
    return {
      accent: style.getPropertyValue('--accent-regular').trim(),
      accentLight: style.getPropertyValue('--accent-light').trim(),
      accentDark: style.getPropertyValue('--accent-dark').trim(),
      chartColors: [
        style.getPropertyValue('--chart-categorical-1').trim(),
        style.getPropertyValue('--chart-categorical-2').trim(),
        style.getPropertyValue('--chart-categorical-3').trim(),
        style.getPropertyValue('--chart-categorical-4').trim(),
        style.getPropertyValue('--chart-categorical-5').trim(),
        style.getPropertyValue('--chart-categorical-6').trim(),
        style.getPropertyValue('--chart-categorical-7').trim(),
        style.getPropertyValue('--chart-categorical-8').trim()
      ].filter(color => color && color !== '')
    };
  }
  
  // Apply theme colors to chart data
  function applyThemeToChartData(data) {
    const themeColors = getThemeColors();
    
    return data.map((trace, index) => {
      const updatedTrace = { ...trace };
      
      // Apply categorical colors for multiple traces
      if (data.length > 1 && themeColors.chartColors.length > 0) {
        const colorIndex = index % themeColors.chartColors.length;
        if (trace.type === 'bar' || trace.type === 'scatter') {
          updatedTrace.marker = {
            ...trace.marker,
            color: trace.marker?.color || themeColors.chartColors[colorIndex]
          };
        } else if (trace.type === 'scatter' && trace.mode?.includes('lines')) {
          updatedTrace.line = {
            ...trace.line,
            color: trace.line?.color || themeColors.chartColors[colorIndex]
          };
        }
      }
      
      // For single traces, use accent color
      if (data.length === 1) {
        if (trace.type === 'bar' && !trace.marker?.color) {
          updatedTrace.marker = {
            ...trace.marker,
            color: themeColors.accent
          };
        } else if (trace.type === 'scatter' && trace.mode?.includes('lines') && !trace.line?.color) {
          updatedTrace.line = {
            ...trace.line,
            color: themeColors.accent
          };
        }
      }
      
      return updatedTrace;
    });
  }

  // Plotly chart initialization
  function initializePlotlyChart(container) {
    try {
      let data = JSON.parse(container.dataset.plotlyData);
      const layout = JSON.parse(container.dataset.plotlyLayout);
      const config = JSON.parse(container.dataset.plotlyConfig);
      
      // Apply theme colors to chart data
      data = applyThemeToChartData(data);
      
      // Remove loading skeleton
      const loadingEl = container.querySelector('.chart-loading');
      if (loadingEl) {
        loadingEl.remove();
      }
      
      // Create the plot
      window.Plotly.newPlot(container, data, layout, config);
      
      // Handle theme changes (both dark/light and color themes)
      const handleThemeChange = () => {
        const isDark = document.documentElement.classList.contains('theme-dark');
        const updatedLayout = {
          ...layout,
          font: {
            ...layout.font,
            color: isDark ? '#a3acc8' : '#3d4663'
          }
        };
        
        // Re-apply theme colors to chart data
        const newData = applyThemeToChartData(JSON.parse(container.dataset.plotlyData));
        
        // Update both layout and data
        window.Plotly.react(container, newData, updatedLayout, config);
      };
      
      // Watch for theme changes
      const observer = new MutationObserver(handleThemeChange);
      observer.observe(document.documentElement, { 
        attributes: true, 
        attributeFilter: ['class'] 
      });
      
      // Listen for custom theme change events
      document.addEventListener('theme-changed', handleThemeChange);
      
    } catch (error) {
      console.error('Failed to initialize Plotly chart:', error);
      container.innerHTML = '<div class="chart-error">Failed to load chart</div>';
    }
  }
  
  // Initialize all charts when page loads
  document.addEventListener('DOMContentLoaded', () => {
    const charts = document.querySelectorAll('.plotly-chart');
    charts.forEach(chart => {
      // Use intersection observer for performance
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initializePlotlyChart(entry.target);
            observer.unobserve(entry.target);
          }
        });
      }, {
        rootMargin: '50px'
      });
      
      observer.observe(chart);
    });
  });
</script>

<style>
  .plotly-chart {
    background: var(--gray-999);
    border-radius: 0.75rem;
    border: 1px solid var(--gray-800);
    overflow: hidden;
    position: relative;
  }
  
  .chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
  }
  
  .loading-skeleton {
    width: 90%;
    height: 90%;
    padding: 1rem;
  }
  
  .skeleton-title {
    height: 24px;
    background: linear-gradient(90deg, var(--gray-800) 25%, var(--gray-700) 50%, var(--gray-800) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin-bottom: 1rem;
    width: 60%;
  }
  
  .skeleton-chart {
    height: calc(100% - 40px);
    background: linear-gradient(90deg, var(--gray-800) 25%, var(--gray-700) 50%, var(--gray-800) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
  }
  
  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
  
  .chart-error {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--gray-400);
    font-style: italic;
  }
  
  /* Responsive adjustments */
  @media (max-width: 50em) {
    .plotly-chart {
      border-radius: 0.5rem;
    }
  }
</style>